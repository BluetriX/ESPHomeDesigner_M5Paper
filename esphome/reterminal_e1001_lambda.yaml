# ============================================================================
# reTerminal E1001 Lambda Rendering Configuration
# ============================================================================
# This config renders your dashboard locally on the device using lambda code.
# 
# REQUIRED CHANGES BEFORE FLASHING:
# 1. Replace YOUR_KEY_HERE with your actual API encryption key (or use !secret)
# 2. Replace YOUR_PASSWORD_HERE with your actual OTA password (or use !secret)
# 3. Update wifi credentials in secrets.yaml or replace !secret references
# 4. Paste your generated dashboard code from the editor (see instructions below)
#
# IMPORTANT: This uses esp-idf framework (not arduino) for better stability
# ============================================================================

esphome:
  name: reterminal-e1001
  friendly_name: reTerminal E1001

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf  # Using esp-idf as per ESPHome auto-generated config

psram:
  mode: octal
  speed: 80MHz

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "YOUR_KEY_HERE"  # ← CHANGE THIS to your API key from ESPHome setup
  # Buzzer control services
  services:
    - service: play_tone
      variables:
        melody: string
      then:
        - rtttl.play: !lambda 'return melody;'

    - service: beep_short
      then:
        - rtttl.play: "beep:d=32,o=5,b=200:16e6"

    - service: beep_ok
      then:
        - rtttl.play: "ok:d=16,o=5,b=200:e6"

    - service: beep_error
      then:
        - rtttl.play: "error:d=16,o=5,b=200:c6"

ota:
  - platform: esphome
    password: "YOUR_PASSWORD_HERE"  # ← CHANGE THIS to your OTA password from ESPHome setup

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "reTerminal Fallback Hotspot"
    password: "5a4DJD5LKoMs"

captive_portal:

time:
  - platform: homeassistant
    id: ha_time

i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

# Outputs: battery enable and buzzer
output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

  - platform: ledc
    pin: GPIO45
    id: buzzer_output

# Buzzer exposed as a controllable component via HA
rtttl:
  id: reterminal_buzzer
  output: buzzer_output

# Onboard SHT4x temperature and humidity sensor exported to HA
sensor:
  - platform: sht4x
    temperature:
      name: "reTerminal Onboard Temperature"
      id: onboard_temperature
      accuracy_decimals: 1
    humidity:
      name: "reTerminal Onboard Humidity"
      id: onboard_humidity
      accuracy_decimals: 1
    address: 0x44
    update_interval: 60s

# Front panel buttons exposed as binary_sensors to HA
binary_sensor:
  - platform: gpio
    id: button_left
    name: "reTerminal Button Left"
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        # Navigate to previous page
        - lambda: |-
            if (id(display_page) > 0) {
              id(display_page) -= 1;
            }
        - component.update: epaper_display

  - platform: gpio
    id: button_right
    name: "reTerminal Button Right"
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        # Navigate to next page (max 9 pages)
        - lambda: |-
            if (id(display_page) < 9) {
              id(display_page) += 1;
            }
        - component.update: epaper_display

  - platform: gpio
    id: button_refresh
    name: "reTerminal Button Refresh"
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        # Force display refresh
        - component.update: epaper_display

# ============================================================================
# STEP 1: PASTE GENERATED CODE SECTIONS HERE (BEFORE display:)
# ============================================================================
# After designing your dashboard in Home Assistant:
# 1. Click "Save Layout" button in the editor
# 2. Click "Generate Snippet" button
# 3. From the generated code, copy and paste these sections HERE:
#
#    a) globals: section (should include display_page, battery_glyph, etc.)
#    b) font: section (Material Design Icons fonts - mdi_24, mdi_32, mdi_48, etc.)
#    c) sensor: section (ONLY if you used sensor_text widgets with Home Assistant entities)
#    d) script: section (if any scripts were generated)
#
# Example of what to paste:
#
# globals:
#   - id: display_page
#     type: int
#     restore_value: yes
#     initial_value: '0'
#   - id: battery_glyph
#     type: std::string
#     restore_value: no
#     initial_value: '"\U000F0079"'
#   - id: page_refresh_default_s
#     type: int
#     restore_value: yes
#     initial_value: '300'
#
# font:
#   - file: "gfonts://Material+Design+Icons"
#     id: mdi_24
#     size: 24
#     glyphs: ["\U000F0594", "\U000F0595", ...]
#   - file: "gfonts://Material+Design+Icons"
#     id: mdi_48
#     size: 48
#     glyphs: ["\U000F0594", ...]
#
# sensor:
#   - platform: homeassistant
#     id: your_sensor_id
#     entity_id: sensor.your_entity
#
# ← PASTE YOUR GLOBALS, FONTS, SENSORS HERE (remove this line after pasting)
# ============================================================================


# Waveshare e-paper display 800x480 (E1001)
display:
  - platform: waveshare_epaper
    id: epaper_display
    model: 7.50inv2
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    lambda: |-
      # =========================================================================
      # STEP 2: PASTE GENERATED DISPLAY LAMBDA CODE HERE (REPLACE THIS BLOCK)
      # =========================================================================
      # From the generated snippet, copy ONLY the display lambda code.
      # This is everything INSIDE the "lambda: |-" block of the display section.
      #
      # It should look like:
      #   it.fill(epd_white);
      #   if (id(display_page) == 0) {
      #     // widget:shape id:w_0 type:rect x:100 y:100 w:200 h:50 fill:true
      #     it.filled_rectangle(100, 100, 200, 50, COLOR_ON);
      #     // widget:icon id:w_1 type:icon x:150 y:125 code:F0595
      #     it.print(150, 125, id(mdi_48), COLOR_OFF, TextAlign::CENTER, "\U000F0595");
      #   }
      #   else if (id(display_page) == 1) {
      #     // Page 1 widgets here
      #   }
      #
      # IMPORTANT: 
      # - Keep the marker comments (// widget:...) - they allow re-importing
      # - Make sure you pasted globals and fonts above BEFORE pasting this
      # - Remove this comment block and the placeholder code below
      # =========================================================================

      // Temporary placeholder - REPLACE with your generated display lambda:
      it.fill(epd_white);
      it.printf(400, 240, TextAlign::CENTER, "Design dashboard in HA, then paste code here");
