esphome:
  name: reterminal-e1001-generic
  friendly_name: reTerminal E1001 Generic
  comment: >
    Generic firmware for the reTerminal E1001 used with the reTerminal Dashboard
    Designer Home Assistant integration.
    - Fetches 800x480 PNG snapshots from Home Assistant.
    - Exposes 3 front buttons, buzzer, onboard temperature and humidity to Home Assistant.
    - Contains NO user-specific sensors or layout logic.

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

psram:
  mode: octal
  speed: 80MHz

logger:

api:
  encryption:
    key: !secret reterminal_api_key

ota:
  platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "reTerminal-E1001-Setup"
    password: "changeme123"

captive_portal:

time:
  - platform: homeassistant
    id: ha_time

i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

# Outputs: battery enable and buzzer
output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

  - platform: ledc
    pin: GPIO45
    id: buzzer_output

# Buzzer exposed as a controllable component via HA
rtttl:
  id: reterminal_buzzer
  output: buzzer_output

# Expose buzzer control as simple API services
api:
  encryption:
    key: !secret reterminal_api_key
  services:
    - service: play_tone
      variables:
        melody: string
      then:
        - rtttl.play: !lambda 'return melody;'

    - service: beep_short
      then:
        - rtttl.play: "beep:d=32,o=5,b=200:16e6"

    - service: beep_ok
      then:
        - rtttl.play: "ok:d=16,o=5,b=200:e6"

    - service: beep_error
      then:
        - rtttl.play: "error:d=16,o=5,b=200:c6"

# Onboard SHT4x temperature and humidity sensor exported to HA
sensor:
  - platform: sht4x
    temperature:
      name: "reTerminal Onboard Temperature"
      id: onboard_temperature
      accuracy_decimals: 1
    humidity:
      name: "reTerminal Onboard Humidity"
      id: onboard_humidity
      accuracy_decimals: 1
    address: 0x44
    update_interval: 60s

# Front panel buttons exposed as binary_sensors to HA
# Adjust GPIOs if your hardware mapping differs
binary_sensor:
  - platform: gpio
    id: button_left
    name: "reTerminal Button Left"
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        # Example: let HA handle page change via service
        - homeassistant.service:
            service: reterminal_dashboard.prev_page
            data:
              device_id: !secret reterminal_device_id

  - platform: gpio
    id: button_right
    name: "reTerminal Button Right"
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        - homeassistant.service:
            service: reterminal_dashboard.next_page
            data:
              device_id: !secret reterminal_device_id

  - platform: gpio
    id: button_refresh
    name: "reTerminal Button Refresh"
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        # Force immediate image refresh from HA
        - component.update: dashboard_image
        - component.update: epaper_display

# Online image fetched from Home Assistant integration
# NOTE:
# - Base URL and token are provided via secrets by the user.
# - HACS integration must implement this PNG endpoint.
http_request:
  verify_ssl: false
  timeout: 30s
  watchdog_timeout: 35s

globals:
  - id: current_page
    type: int
    restore_value: yes
    initial_value: '0'

  - id: total_pages
    type: int
    restore_value: no
    initial_value: '3'  # can be updated via HA service or template if needed

# Image source: rendered by the reterminal_dashboard HA integration
online_image:
  - id: dashboard_image
    format: PNG
    type: BINARY
    url: !lambda |-
      // URL pattern is intentionally generic and integration-owned.
      // Example:
      // http://homeassistant.local:8123/api/reterminal_dashboard/{device_id}/page/{page}/image.png?token={token}
      char buf[512];
      snprintf(
        buf,
        sizeof(buf),
        "http://%s/api/reterminal_dashboard/%s/page/%d/image.png?token=%s",
        "${reterminal_ha_host}",
        "${reterminal_device_id}",
        id(current_page),
        "${reterminal_api_token}"
      );
      return std::string(buf);
    update_interval: 5min
    on_download_finished:
      then:
        - logger.log: "Dashboard image downloaded successfully"
        - component.update: epaper_display
    on_error:
      then:
        - logger.log: "Dashboard image download FAILED"

# Waveshare e-paper display 800x480 (E1001)
display:
  - platform: waveshare_epaper
    id: epaper_display
    model: 7.50inv2
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    lambda: |-
      // Render the fetched PNG full-screen if available.
      // The PNG is prepared for 800x480 by the HA integration.
      it.fill(epd_white);
      if (id(dashboard_image).has_data()) {
        it.image(0, 0, id(dashboard_image));
      } else {
        // Simple fallback screen
        it.printf(400, 220, id(font_normal), TextAlign::CENTER, "Waiting for dashboard image...");
      }

# Minimal fonts referenced above (you can extend in your own project)
font:
  - file: "gfonts://Inter@400"
    id: font_normal
    size: 20